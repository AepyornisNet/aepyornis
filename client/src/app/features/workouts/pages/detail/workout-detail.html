<div class="container-fluid my-2">
  @if (dataService.loading()) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">{{ 'statistics.loading' | translate }}</span>
      </div>
    </div>
  }

  @if (dataService.error()) {
    <div class="alert alert-danger" role="alert">
      {{ dataService.error() }}
    </div>
    <button class="btn btn-primary" (click)="goBack()">
      {{ 'dashboard.workouts' | translate }}
    </button>
  }

  @if (!dataService.loading() && !dataService.error() && dataService.workout()) {
    <div class="row">
      <div class="col-12 col-lg-8">
        <div class="workout-header">
          <div class="d-flex align-items-center gap-3">
            <h1 class="display-4 mb-0">
              <app-icon size="32" [name]="dataService.workout()!.type" />
              {{ dataService.workout()!.name }}
            </h1>
            @if (dataService.workout()!.locked) {
              <span class="badge bg-warning">
                <app-icon name="locked" size="16" />
                Locked
              </span>
            }
          </div>
          <div class="d-flex gap-2 align-items-center flex-wrap">
            <button class="btn btn-outline-secondary" (click)="goBack()">
              {{ 'shared.back' | translate }}
            </button>
          </div>
        </div>

        <!-- Workout Stats -->
        <div class="workout-stats">
          @if (dataService.workout()!.total_distance) {
            <div class="stat-card">
              <div class="stat-label">{{ 'dashboard.distance' | translate }}</div>
              <div class="stat-value">
                {{ dataService.formatDistance(dataService.workout()!.total_distance!) }} km
              </div>
            </div>
          }

          @if (dataService.workout()!.total_duration) {
            <div class="stat-card">
              <div class="stat-label">{{ 'dashboard.duration' | translate }}</div>
              <div class="stat-value">
                {{ dataService.formatDuration(dataService.workout()!.total_duration!) }}
              </div>
            </div>
          }

          @if (dataService.workout()!.average_speed) {
            <div class="stat-card">
              <div class="stat-label">{{ 'dashboard.average_speed' | translate }}</div>
              <div class="stat-value">
                {{ dataService.formatSpeed(dataService.workout()!.average_speed!) }} km/h
              </div>
            </div>
          }

          @if (dataService.workout()!.max_speed) {
            <div class="stat-card">
              <div class="stat-label">{{ 'dashboard.max_speed' | translate }}</div>
              <div class="stat-value">
                {{ dataService.formatSpeed(dataService.workout()!.max_speed!) }} km/h
              </div>
            </div>
          }

          @if (dataService.workout()!.total_up) {
            <div class="stat-card">
              <div class="stat-label">{{ 'dashboard.elevation' | translate }}</div>
              <div class="stat-value">
                {{ dataService.formatElevation(dataService.workout()!.total_up!) }} m
              </div>
            </div>
          }

          @if (dataService.workout()!.total_down) {
            <div class="stat-card">
              <div class="stat-label">{{ 'route_segment.total_down' | translate }}</div>
              <div class="stat-value">
                {{ dataService.formatElevation(dataService.workout()!.total_down!) }} m
              </div>
            </div>
          }

          @if (dataService.workout()!.min_elevation || dataService.workout()!.max_elevation) {
            <div class="stat-card">
              <div class="stat-label">{{ 'dashboard.elevation_range' | translate }}</div>
              <div class="stat-value">
                {{ dataService.formatElevation(dataService.workout()!.min_elevation || 0) }} -
                {{ dataService.formatElevation(dataService.workout()!.max_elevation || 0) }} m
              </div>
            </div>
          }
        </div>

        <!-- Map -->
        @if (dataService.hasMapData()) {
          <div class="card shadow-sm mb-4">
            <div class="card-body p-0">
              <div class="map-container">
                <app-workout-map
                  [center]="dataService.workout()!.map_data!.center"
                  [mapData]="dataService.workout()!.map_data!.details"
                />
              </div>
            </div>
          </div>
        }

        <!-- Chart -->
        @if (dataService.hasMapData()) {
          <div class="card shadow-sm mb-4">
            <div class="card-header">
              <ul #statistics="ngbNav" class="nav nav-tabs card-header-tabs" ngbNav>
                <li ngbNavItem>
                  <button ngbNavLink>{{ 'workout.time_chart' | translate }}</button>
                  <ng-template ngbNavContent>
                    <div class="chart-container">
                      <app-workout-chart
                        [extraMetrics]="dataService.workout()!.map_data!.extra_metrics || []"
                        [mapData]="dataService.workout()!.map_data!.details"
                      />
                    </div>
                  </ng-template>
                </li>
                <li ngbNavItem>
                  <button ngbNavLink>{{ 'workout.distance_chart' | translate }}</button>
                  <ng-template ngbNavContent>
                    <div class="chart-container">
                      <app-workout-chart
                        [extraMetrics]="dataService.workout()!.map_data!.extra_metrics || []"
                        [mapData]="dataService.workout()!.map_data!.details"
                        [viewMode]="'distance'"
                      />
                    </div>
                  </ng-template>
                </li>
                @if (hasWorkoutStatisticsTab() && dataService.workout()) {
                  <li ngbNavItem>
                    <button ngbNavLink>{{ 'shared.statistics' | translate }}</button>
                    <ng-template ngbNavContent>
                      <app-workout-statistics [workout]="dataService.workout()!" />
                    </ng-template>
                  </li>
                }
                @if (dataService.hasHeartRateDistribution()) {
                  <li ngbNavItem>
                    <button ngbNavLink>{{ 'workout.hr-distribution' | translate }}</button>
                    <ng-template ngbNavContent>
                      <app-workout-zone-distribution
                        type="heart-rate"
                        [mapData]="dataService.workout()!.map_data!.details"
                      />
                    </ng-template>
                  </li>
                }
                @if (dataService.hasPowerDistribution()) {
                  <li ngbNavItem>
                    <button ngbNavLink>{{ 'workout.power-distribution' | translate }}</button>
                    <ng-template ngbNavContent>
                      <app-workout-zone-distribution
                        type="power"
                        [mapData]="dataService.workout()!.map_data!.details"
                      />
                    </ng-template>
                  </li>
                }
              </ul>
            </div>
            <div class="card-body tab-content" [ngbNavOutlet]="statistics"></div>
          </div>
        }

        @if (
          dataService.hasMapData() &&
          dataService.workout()!.total_distance &&
          dataService.workout()!.total_distance! > 1000
        ) {
          <div class="card shadow-sm mb-4">
            <div class="card-header">
              <ul #intervalsNav="ngbNav" class="nav nav-tabs card-header-tabs" ngbNav>
                <!-- Workout Breakdown (Laps + Intervals) -->
                <li ngbNavItem>
                  <button ngbNavLink>{{ 'workout.breakdown' | translate }}</button>
                  <ng-template ngbNavContent>
                    <app-workout-breakdown
                      [extraMetrics]="dataService.workout()!.map_data!.extra_metrics || []"
                      [totalDistance]="dataService.workout()!.total_distance"
                      [workoutId]="dataService.workout()!.id"
                    />
                  </ng-template>
                </li>

                <!-- Route Segment Matches -->
                @if (dataService.hasRouteSegmentMatches()) {
                  <li ngbNavItem>
                    <button ngbNavLink>{{ 'shared.matching_route_segments' | translate }}</button>
                    <ng-template ngbNavContent>
                      <app-route-segment-matches
                        [matches]="dataService.workout()!.route_segment_matches!"
                      />
                    </ng-template>
                  </li>
                }

                <!-- Climbs -->
                @if (dataService.hasClimbs()) {
                  <li ngbNavItem>
                    <button ngbNavLink>{{ 'shared.climbs_and_descents' | translate }}</button>
                    <ng-template ngbNavContent>
                      <app-workout-climbs [climbs]="dataService.workout()!.climbs!" />
                    </ng-template>
                  </li>
                }
              </ul>
            </div>
            <div class="card-body tab-content" [ngbNavOutlet]="intervalsNav"></div>
          </div>
        }
      </div>
      <div class="col-12 col-lg-4">
        <!-- Additional Details -->
        <div class="card shadow-sm mb-4">
          <div class="card-header">
            <h5 class="mb-0">{{ 'equipment.details' | translate }}</h5>
          </div>
          <div class="card-body">
            <dl class="row mb-0">
              <dt class="col-sm-3">{{ 'workout.type' | translate }}</dt>
              <dd class="col-sm-9">
                <app-icon size="20" [name]="dataService.workout()!.type" />
                {{ `sports.${dataService.workout()!.type}` | translate }}
                @if (dataService.workout()!.custom_type) {
                  <em>({{ dataService.workout()!.custom_type }})</em>
                }
              </dd>

              @if (dataService.workout()!.sub_type) {
                <dt class="col-sm-3">{{ 'workout.sub_type' | translate }}</dt>
                <dd class="col-sm-9">{{ `sports_subtypes.${dataService.workout()!.sub_type}` | translate }}</dd>
              }

              <dt class="col-sm-3">{{ 'workout.date' | translate }}</dt>
              <dd class="col-sm-9">{{ dataService.formatDate(dataService.workout()!.date) }}</dd>

              @if (dataService.workout()!.address_string) {
                <dt class="col-sm-3">{{ 'route_segment.location' | translate }}</dt>
                <dd class="col-sm-9">{{ dataService.workout()!.address_string }}</dd>
              }

              @if (dataService.workout()!.map_data?.creator) {
                <dt class="col-sm-3">{{ 'shared.source' | translate }}</dt>
                <dd class="col-sm-9">{{ dataService.workout()!.map_data!.creator }}</dd>
              }

              @if (dataService.workout()!.locked) {
                <dt class="col-sm-3">{{ 'shared.status' | translate }}</dt>
                <dd class="col-sm-9">
                  <span class="badge bg-warning">{{ 'shared.locked' | translate }}</span>
                </dd>
              }
            </dl>
          </div>
        </div>

        <!-- Notes -->
        @if (dataService.workout()!.notes) {
          <div class="card shadow-sm mb-4">
            <div class="card-header">
              <h5 class="mb-0">{{ 'equipment.notes' | translate }}</h5>
            </div>
            <div class="card-body">
              <p class="mb-0" style="white-space: pre-wrap">{{ dataService.workout()!.notes }}</p>
            </div>
          </div>
        }

        <!-- Equipment -->
        @if (dataService.workout()!.equipment && dataService.workout()!.equipment!.length > 0) {
          <div class="card shadow-sm mb-4">
            <div class="card-header">
              <h5 class="mb-0">{{ 'equipment.equipment' | translate }}</h5>
            </div>
            <div class="card-body">
              <div class="list-group">
                @for (equip of dataService.workout()!.equipment; track equip.id) {
                  <a class="list-group-item" [routerLink]="['/equipment', equip.id]">
                    <h6 class="mb-1">{{ equip.name }}</h6>
                    @if (equip.description) {
                      <p class="mb-0 text-muted">{{ equip.description }}</p>
                    }
                  </a>
                }
              </div>
            </div>
          </div>
        }

        <app-workout-actions
          [hasMapData]="dataService.hasMapData()!"
          [workout]="dataService.workout()!"
          (workoutDeleted)="onWorkoutDeleted()"
          (workoutUpdated)="onWorkoutUpdated($event)"
        />
      </div>
    </div>
  }
</div>
